stages:
  - deploy

deploy:
  stage: deploy
  image: kroniak/ssh-client

  only:
    - master

  before_script:
    - mkdir -p ~/.ssh
    - echo "$MASTER_SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - echo "$(cat ~/.ssh/id_rsa)"
    - chmod 700 ~/.ssh/id_rsa
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/id_rsa
    - ssh-keyscan -H 'gitlab.com' >> ~/.ssh/known_hosts

  script:
    - ssh -o StrictHostKeyChecking=no "${MASTER_SSH_USER}@${MASTER_HOST}" "cd /var/www/mc-client"
    - ssh -o StrictHostKeyChecking=no "${MASTER_SSH_USER}@${MASTER_HOST}" "sudo git pull"
    - ssh -o StrictHostKeyChecking=no "${MASTER_SSH_USER}@${MASTER_HOST}" "export REACT_APP_SERVER_URL=$REACT_APP_SERVER_URL"
    - ssh -o StrictHostKeyChecking=no "${MASTER_SSH_USER}@${MASTER_HOST}" "export REACT_APP_PEER_SERVER_URL=$REACT_APP_PEER_SERVER_URL"
    - ssh -o StrictHostKeyChecking=no "${MASTER_SSH_USER}@${MASTER_HOST}" "export REACT_APP_PEER_SERVER_PORT=$REACT_APP_PEER_SERVER_PORT"
    - ssh -o StrictHostKeyChecking=no "${MASTER_SSH_USER}@${MASTER_HOST}" "sudo npm run build && sudo service nginx restart"
    - ssh -o StrictHostKeyChecking=no "${MASTER_SSH_USER}@${MASTER_HOST}" "sudo service nginx restart"